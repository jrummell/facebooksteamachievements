<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Default settings are for Staging -->
    <MSBuildCommunityTasksPath>.\</MSBuildCommunityTasksPath>
    <Configuration Condition=" '$(Configuration)' == '' ">Staging</Configuration>
    <DeployIisSite Condition=" '$(DeployIisSite)' == '' ">fbsteamachievements.com</DeployIisSite>
    <WebApplicationPath Condition=" '$(WebApplicationPath)' == '' ">staging/fbsa/canvas</WebApplicationPath>
    <ProjectName Condition=" '$(ProjectName)' == '' ">SteamAchievements.Web</ProjectName>
    <AppRelativeConfigPath>App_Data\Config</AppRelativeConfigPath>
    <ConfigPath>$(ProjectName)\$(AppRelativeConfigPath)</ConfigPath>
  </PropertyGroup>

  <Import Project=".build\MSBuild.Community.Tasks.Targets" />

  <Target Name="Build" DependsOnTargets="DeploySite;FtpConfig" />

  <Target Name="DeploySite">
    <!-- Build the deployment package and deploy it. -->
    <MSBuild Projects="$(ProjectName)\$(ProjectName).csproj"
             Properties="Configuration=$(Configuration);
                             DeployOnBuild=True;
                             DeployTarget=MSDeployPublish;
                             MsDeployServiceUrl=$(MsDeployServiceUrl);
                             DeployIisAppPath=$(DeployIisSite)/$(WebApplicationPath);
                             AllowUntrustedCertificate=True;
                             MSDeployPublishMethod=WMSvc;
                             CreatePackageOnPublish=True;
                             SkipExtraFilesOnServer=True;
                             UserName=$(UserName);
                             Password=$(Password);" />
  </Target>

  <Target Name="FtpConfig">
    <!-- FTP the config files -->
    <ItemGroup>
      <configFiles Include="$(ConfigPath)\**\$(Configuration)\*.config"
                   Exclude="$(ConfigPath)\**\.hg\**" />
    </ItemGroup>

    <!-- This times out ...
    <FtpUpload Username="$(UserName)"
               Password="$(Password)"
               LocalFiles="@(configFiles)"
               RemoteFiles="@(configFiles->'%(RecursiveDir)%(Filename)%(Extension)')"
               RemoteUri="ftp://$(DeployIisSite)/$(WebApplicationPath)/$(AppRelativeConfigPath)/" />-->
  </Target>

</Project>